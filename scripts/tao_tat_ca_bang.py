#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
T·∫°o t·∫•t c·∫£ b·∫£ng v√† d·ªØ li·ªáu trong database ECommerce_Test
"""
import pymssql
import random
import json
from datetime import datetime, timedelta

# C√†i ƒë·∫∑t faker
try:
    from faker import Faker
    fake = Faker('vi_VN')
except ImportError:
    import subprocess
    print("üì¶ ƒêang c√†i ƒë·∫∑t faker...")
    subprocess.run(['pip', 'install', 'faker'], check=True)
    from faker import Faker
    fake = Faker('vi_VN')

def ket_noi_database():
    """K·∫øt n·ªëi t·ªõi database ECommerce_Test"""
    try:
        ket_noi = pymssql.connect(
            server='127.0.0.1',
            port=1235,
            user='sa',
            password='YourStrong!Pass123',
            database='ECommerce_Test'
        )
        return ket_noi
    except Exception as e:
        print(f"‚ùå L·ªói k·∫øt n·ªëi database: {e}")
        return None

def tao_tat_ca_bang():
    """T·∫°o t·∫•t c·∫£ b·∫£ng v√† d·ªØ li·ªáu"""
    print("üöÄ B·∫ÆT ƒê·∫¶U T·∫†O T·∫§T C·∫¢ B·∫¢NG V√Ä D·ªÆ LI·ªÜU")
    print("=" * 50)
    
    ket_noi = ket_noi_database()
    if not ket_noi:
        return False
    
    try:
        con_tro = ket_noi.cursor()
        
        # 1. T·∫°o b·∫£ng kh√°ch h√†ng
        print("üìä ƒêang t·∫°o b·∫£ng khach_hang...")
        con_tro.execute('''
        CREATE TABLE khach_hang (
            id INT IDENTITY(1,1) PRIMARY KEY,
            ten_khach_hang NVARCHAR(100) NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL,
            so_dien_thoai VARCHAR(20),
            dia_chi NVARCHAR(200),
            thanh_pho NVARCHAR(50),
            ngay_sinh DATE,
            gioi_tinh NVARCHAR(10),
            ngay_dang_ky DATETIME DEFAULT GETDATE(),
            trang_thai NVARCHAR(20) DEFAULT N'Ho·∫°t ƒë·ªông',
            diem_thuong INT DEFAULT 0
        )
        ''')
        
        # Th√™m d·ªØ li·ªáu kh√°ch h√†ng
        thanh_pho_list = ['H√† N·ªôi', 'TP. H·ªì Ch√≠ Minh', 'ƒê√† N·∫µng', 'H·∫£i Ph√≤ng', 'C·∫ßn Th∆°']
        khach_hang_data = []
        for i in range(500):
            ten = fake.name()
            email = f"khach{i+1}@email.com"
            sdt = fake.phone_number()
            dia_chi = fake.address()
            thanh_pho = random.choice(thanh_pho_list)
            ngay_sinh = fake.date_of_birth(minimum_age=18, maximum_age=65)
            gioi_tinh = random.choice(['Nam', 'N·ªØ'])
            ngay_dk = fake.date_time_between(start_date='-2y', end_date='now')
            trang_thai = random.choice(['Ho·∫°t ƒë·ªông', 'VIP', 'T·∫°m kh√≥a'])
            diem = random.randint(0, 5000)
            
            khach_hang_data.append((ten, email, sdt, dia_chi, thanh_pho, ngay_sinh, 
                                  gioi_tinh, ngay_dk, trang_thai, diem))
        
        con_tro.executemany('''
        INSERT INTO khach_hang (ten_khach_hang, email, so_dien_thoai, dia_chi, thanh_pho, 
                               ngay_sinh, gioi_tinh, ngay_dang_ky, trang_thai, diem_thuong)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        ''', khach_hang_data)
        print("‚úÖ ƒê√£ t·∫°o b·∫£ng khach_hang v·ªõi 500 records")
        
        # 2. T·∫°o b·∫£ng danh m·ª•c
        print("üìä ƒêang t·∫°o b·∫£ng danh_muc...")
        con_tro.execute('''
        CREATE TABLE danh_muc (
            id INT IDENTITY(1,1) PRIMARY KEY,
            ten_danh_muc NVARCHAR(100) NOT NULL,
            mo_ta NVARCHAR(300),
            trang_thai NVARCHAR(20) DEFAULT N'Ho·∫°t ƒë·ªông',
            ngay_tao DATETIME DEFAULT GETDATE()
        )
        ''')
        
        danh_muc_data = [
            ('ƒêi·ªán tho·∫°i', 'ƒêi·ªán tho·∫°i th√¥ng minh c√°c lo·∫°i', 'Ho·∫°t ƒë·ªông'),
            ('Laptop', 'M√°y t√≠nh x√°ch tay', 'Ho·∫°t ƒë·ªông'),
            ('Tablet', 'M√°y t√≠nh b·∫£ng', 'Ho·∫°t ƒë·ªông'),
            ('Ph·ª• ki·ªán', 'Ph·ª• ki·ªán ƒëi·ªán t·ª≠', 'Ho·∫°t ƒë·ªông'),
            ('Th·ªùi trang Nam', 'Qu·∫ßn √°o nam', 'Ho·∫°t ƒë·ªông'),
            ('Th·ªùi trang N·ªØ', 'Qu·∫ßn √°o n·ªØ', 'Ho·∫°t ƒë·ªông'),
            ('Gi√†y d√©p', 'Gi√†y d√©p c√°c lo·∫°i', 'Ho·∫°t ƒë·ªông'),
            ('Gia d·ª•ng', 'ƒê·ªì gia d·ª•ng', 'Ho·∫°t ƒë·ªông'),
            ('S√°ch', 'S√°ch v√† vƒÉn ph√≤ng ph·∫©m', 'Ho·∫°t ƒë·ªông'),
            ('Th·ªÉ thao', 'ƒê·ªì th·ªÉ thao', 'Ho·∫°t ƒë·ªông')
        ]
        
        con_tro.executemany('''
        INSERT INTO danh_muc (ten_danh_muc, mo_ta, trang_thai)
        VALUES (%s, %s, %s)
        ''', danh_muc_data)
        print("‚úÖ ƒê√£ t·∫°o b·∫£ng danh_muc v·ªõi 10 records")
        
        # 3. T·∫°o b·∫£ng s·∫£n ph·∫©m
        print("üìä ƒêang t·∫°o b·∫£ng san_pham...")
        con_tro.execute('''
        CREATE TABLE san_pham (
            id INT IDENTITY(1,1) PRIMARY KEY,
            ten_san_pham NVARCHAR(200) NOT NULL,
            ma_san_pham VARCHAR(50) UNIQUE NOT NULL,
            danh_muc_id INT NOT NULL,
            mo_ta NVARCHAR(500),
            gia_ban DECIMAL(18,2) NOT NULL,
            gia_nhap DECIMAL(18,2),
            so_luong_ton INT DEFAULT 0,
            thuong_hieu NVARCHAR(100),
            mau_sac NVARCHAR(50),
            diem_danh_gia DECIMAL(3,2) DEFAULT 0,
            luot_xem INT DEFAULT 0,
            trang_thai NVARCHAR(20) DEFAULT N'C√≤n h√†ng',
            ngay_tao DATETIME DEFAULT GETDATE()
        )
        ''')
        
        # Th√™m d·ªØ li·ªáu s·∫£n ph·∫©m
        san_pham_data = []
        thuong_hieu_list = ['Samsung', 'Apple', 'Xiaomi', 'HP', 'Dell', 'ASUS', 'Nike', 'Adidas']
        mau_sac_list = ['ƒêen', 'Tr·∫Øng', 'X√°m', 'V√†ng', 'Xanh', 'ƒê·ªè']
        
        for i in range(1000):
            ten_sp = f"S·∫£n ph·∫©m {fake.word().title()} {i+1}"
            ma_sp = f"SP{i+1:04d}"
            danh_muc_id = random.randint(1, 10)
            mo_ta = f"M√¥ t·∫£ chi ti·∫øt cho {ten_sp}"
            gia_ban = random.randint(100000, 20000000)
            gia_nhap = int(gia_ban * random.uniform(0.6, 0.8))
            so_luong = random.randint(0, 100)
            thuong_hieu = random.choice(thuong_hieu_list)
            mau_sac = random.choice(mau_sac_list)
            diem = round(random.uniform(3.0, 5.0), 1)
            luot_xem = random.randint(0, 5000)
            trang_thai = random.choice(['C√≤n h√†ng', 'H·∫øt h√†ng', 'Ng∆∞ng b√°n'])
            ngay_tao = fake.date_time_between(start_date='-1y', end_date='now')
            
            san_pham_data.append((ten_sp, ma_sp, danh_muc_id, mo_ta, gia_ban, gia_nhap,
                                so_luong, thuong_hieu, mau_sac, diem, luot_xem, trang_thai, ngay_tao))
        
        con_tro.executemany('''
        INSERT INTO san_pham (ten_san_pham, ma_san_pham, danh_muc_id, mo_ta, gia_ban, gia_nhap,
                             so_luong_ton, thuong_hieu, mau_sac, diem_danh_gia, luot_xem, trang_thai, ngay_tao)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        ''', san_pham_data)
        print("‚úÖ ƒê√£ t·∫°o b·∫£ng san_pham v·ªõi 1000 records")
        
        # 4. T·∫°o b·∫£ng ƒë∆°n h√†ng
        print("üìä ƒêang t·∫°o b·∫£ng don_hang...")
        con_tro.execute('''
        CREATE TABLE don_hang (
            id INT IDENTITY(1,1) PRIMARY KEY,
            ma_don_hang VARCHAR(50) UNIQUE NOT NULL,
            khach_hang_id INT NOT NULL,
            ngay_dat_hang DATETIME DEFAULT GETDATE(),
            tong_tien DECIMAL(18,2) NOT NULL,
            phi_van_chuyen DECIMAL(18,2) DEFAULT 0,
            giam_gia DECIMAL(18,2) DEFAULT 0,
            tong_thanh_toan DECIMAL(18,2) NOT NULL,
            phuong_thuc_thanh_toan NVARCHAR(50),
            trang_thai_thanh_toan NVARCHAR(30),
            trang_thai_don_hang NVARCHAR(30),
            dia_chi_giao_hang NVARCHAR(300),
            ghi_chu NVARCHAR(200)
        )
        ''')
        
        # Th√™m d·ªØ li·ªáu ƒë∆°n h√†ng
        don_hang_data = []
        phuong_thuc_tt = ['Ti·ªÅn m·∫∑t', 'Chuy·ªÉn kho·∫£n', 'Th·∫ª t√≠n d·ª•ng', 'COD']
        trang_thai_tt = ['Ch∆∞a thanh to√°n', 'ƒê√£ thanh to√°n', 'Thanh to√°n m·ªôt ph·∫ßn']
        trang_thai_dh = ['Ch·ªù x·ª≠ l√Ω', 'ƒê√£ x√°c nh·∫≠n', 'ƒêang giao', 'ƒê√£ giao', 'ƒê√£ h·ªßy']
        
        for i in range(1500):
            ma_dh = f"DH{i+1:06d}"
            khach_hang_id = random.randint(1, 500)
            ngay_dat = fake.date_time_between(start_date='-6m', end_date='now')
            tong_tien = random.randint(500000, 10000000)
            phi_vc = random.choice([0, 25000, 50000])
            giam_gia = random.randint(0, int(tong_tien * 0.1))
            tong_tt = tong_tien + phi_vc - giam_gia
            phuong_thuc = random.choice(phuong_thuc_tt)
            tt_thanh_toan = random.choice(trang_thai_tt)
            tt_don_hang = random.choice(trang_thai_dh)
            dia_chi = fake.address()
            ghi_chu = random.choice(['', 'Giao h√†ng nhanh', 'Ki·ªÉm tra k·ªπ'])
            
            don_hang_data.append((ma_dh, khach_hang_id, ngay_dat, tong_tien, phi_vc, giam_gia,
                                tong_tt, phuong_thuc, tt_thanh_toan, tt_don_hang, dia_chi, ghi_chu))
        
        con_tro.executemany('''
        INSERT INTO don_hang (ma_don_hang, khach_hang_id, ngay_dat_hang, tong_tien, 
                             phi_van_chuyen, giam_gia, tong_thanh_toan, phuong_thuc_thanh_toan,
                             trang_thai_thanh_toan, trang_thai_don_hang, dia_chi_giao_hang, ghi_chu)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        ''', don_hang_data)
        print("‚úÖ ƒê√£ t·∫°o b·∫£ng don_hang v·ªõi 1500 records")
        
        # 5. T·∫°o b·∫£ng chi ti·∫øt ƒë∆°n h√†ng
        print("üìä ƒêang t·∫°o b·∫£ng chi_tiet_don_hang...")
        con_tro.execute('''
        CREATE TABLE chi_tiet_don_hang (
            id INT IDENTITY(1,1) PRIMARY KEY,
            don_hang_id INT NOT NULL,
            san_pham_id INT NOT NULL,
            so_luong INT NOT NULL,
            gia_ban DECIMAL(18,2) NOT NULL,
            thanh_tien DECIMAL(18,2) NOT NULL
        )
        ''')
        
        # Th√™m chi ti·∫øt ƒë∆°n h√†ng
        chi_tiet_data = []
        for don_hang_id in range(1, 1501):
            so_san_pham = random.randint(1, 4)
            for _ in range(so_san_pham):
                san_pham_id = random.randint(1, 1000)
                so_luong = random.randint(1, 3)
                gia_ban = random.randint(100000, 3000000)
                thanh_tien = so_luong * gia_ban
                chi_tiet_data.append((don_hang_id, san_pham_id, so_luong, gia_ban, thanh_tien))
        
        con_tro.executemany('''
        INSERT INTO chi_tiet_don_hang (don_hang_id, san_pham_id, so_luong, gia_ban, thanh_tien)
        VALUES (%s, %s, %s, %s, %s)
        ''', chi_tiet_data)
        print(f"‚úÖ ƒê√£ t·∫°o b·∫£ng chi_tiet_don_hang v·ªõi {len(chi_tiet_data)} records")
        
        # 6. T·∫°o b·∫£ng ƒë√°nh gi√°
        print("üìä ƒêang t·∫°o b·∫£ng danh_gia_san_pham...")
        con_tro.execute('''
        CREATE TABLE danh_gia_san_pham (
            id INT IDENTITY(1,1) PRIMARY KEY,
            san_pham_id INT NOT NULL,
            khach_hang_id INT NOT NULL,
            diem_danh_gia INT CHECK (diem_danh_gia >= 1 AND diem_danh_gia <= 5),
            tieu_de NVARCHAR(200),
            noi_dung NVARCHAR(1000),
            ngay_danh_gia DATETIME DEFAULT GETDATE(),
            trang_thai NVARCHAR(20) DEFAULT N'Hi·ªÉn th·ªã'
        )
        ''')
        
        # Th√™m ƒë√°nh gi√°
        danh_gia_data = []
        tieu_de_list = ['S·∫£n ph·∫©m t·ªët', 'Ch·∫•t l∆∞·ª£ng cao', 'Gi√° h·ª£p l√Ω', 'H√†i l√≤ng', 'B√¨nh th∆∞·ªùng']
        noi_dung_list = ['S·∫£n ph·∫©m ƒë√∫ng m√¥ t·∫£', 'Giao h√†ng nhanh', 'Ch·∫•t l∆∞·ª£ng OK', 'S·∫Ω mua l·∫°i']
        
        for i in range(2000):
            san_pham_id = random.randint(1, 1000)
            khach_hang_id = random.randint(1, 500)
            diem = random.randint(3, 5)
            tieu_de = random.choice(tieu_de_list)
            noi_dung = random.choice(noi_dung_list)
            ngay_dg = fake.date_time_between(start_date='-6m', end_date='now')
            trang_thai = 'Hi·ªÉn th·ªã'
            
            danh_gia_data.append((san_pham_id, khach_hang_id, diem, tieu_de, noi_dung, ngay_dg, trang_thai))
        
        con_tro.executemany('''
        INSERT INTO danh_gia_san_pham (san_pham_id, khach_hang_id, diem_danh_gia, tieu_de, 
                                      noi_dung, ngay_danh_gia, trang_thai)
        VALUES (%s, %s, %s, %s, %s, %s, %s)
        ''', danh_gia_data)
        print("‚úÖ ƒê√£ t·∫°o b·∫£ng danh_gia_san_pham v·ªõi 2000 records")
        
        # 7. T·∫°o b·∫£ng nh√¢n vi√™n
        print("üìä ƒêang t·∫°o b·∫£ng nhan_vien...")
        con_tro.execute('''
        CREATE TABLE nhan_vien (
            id INT IDENTITY(1,1) PRIMARY KEY,
            ma_nhan_vien VARCHAR(20) UNIQUE NOT NULL,
            ten_nhan_vien NVARCHAR(100) NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL,
            so_dien_thoai VARCHAR(20),
            chuc_vu NVARCHAR(50),
            phong_ban NVARCHAR(50),
            luong_co_ban DECIMAL(18,2),
            ngay_vao_lam DATE,
            trang_thai NVARCHAR(20) DEFAULT N'ƒêang l√†m vi·ªác'
        )
        ''')
        
        # Th√™m nh√¢n vi√™n
        nhan_vien_data = []
        chuc_vu_list = ['Nh√¢n vi√™n', 'Tr∆∞·ªüng nh√≥m', 'Qu·∫£n l√Ω', 'Th·ª±c t·∫≠p sinh']
        phong_ban_list = ['Kinh doanh', 'K·ªπ thu·∫≠t', 'Marketing', 'Nh√¢n s·ª±', 'K·∫ø to√°n']
        
        for i in range(50):
            ma_nv = f"NV{i+1:03d}"
            ten_nv = fake.name()
            email = f"nhanvien{i+1}@company.com"
            sdt = fake.phone_number()
            chuc_vu = random.choice(chuc_vu_list)
            phong_ban = random.choice(phong_ban_list)
            luong = random.randint(8000000, 30000000)
            ngay_vao = fake.date_between(start_date='-2y', end_date='now')
            trang_thai = 'ƒêang l√†m vi·ªác'
            
            nhan_vien_data.append((ma_nv, ten_nv, email, sdt, chuc_vu, phong_ban, luong, ngay_vao, trang_thai))
        
        con_tro.executemany('''
        INSERT INTO nhan_vien (ma_nhan_vien, ten_nhan_vien, email, so_dien_thoai, 
                              chuc_vu, phong_ban, luong_co_ban, ngay_vao_lam, trang_thai)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
        ''', nhan_vien_data)
        print("‚úÖ ƒê√£ t·∫°o b·∫£ng nhan_vien v·ªõi 50 records")
        
        # Commit t·∫•t c·∫£ thay ƒë·ªïi
        ket_noi.commit()
        ket_noi.close()
        
        print("\n" + "=" * 50)
        print("üéâ HO√ÄN TH√ÄNH T·∫†O T·∫§T C·∫¢ B·∫¢NG!")
        print("üìä Database ECommerce_Test ƒë√£ c√≥ ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu:")
        print("   ‚Ä¢ khach_hang: 500 records")
        print("   ‚Ä¢ danh_muc: 10 records")
        print("   ‚Ä¢ san_pham: 1000 records")
        print("   ‚Ä¢ don_hang: 1500 records")
        print("   ‚Ä¢ chi_tiet_don_hang: ~4000 records")
        print("   ‚Ä¢ danh_gia_san_pham: 2000 records")
        print("   ‚Ä¢ nhan_vien: 50 records")
        print("\nüöÄ Gi·ªù c√≥ th·ªÉ test Universal Connector!")
        
        return True
        
    except Exception as e:
        print(f"‚ùå L·ªói: {e}")
        ket_noi.rollback()
        ket_noi.close()
        return False

if __name__ == '__main__':
    tao_tat_ca_bang()
